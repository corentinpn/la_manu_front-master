name: Pipeline CD

on:
  workflow_dispatch:

jobs:
  deploy:
    name:  Self-hosted CD Pipeline
    runs-on: self-hosted

    steps:
      - name:  Checkout code
        uses: actions/checkout@v3

      - name:  Terraform init & apply â†’ VM (VirtualBox Ubuntu)
        working-directory: ./infra/terraform
        run: |
          terraform init
          terraform apply -auto-approve

      - name:  Ansible provision VM
        working-directory: ./infra/ansible
        run: |
          ansible-playbook -i inventory/prod.ini provision.yml

      - name:  Ansible deploy (Docker image + Compose)
        working-directory: ./infra/ansible
        run: |
          ansible-playbook -i inventory/prod.ini deploy.yml
