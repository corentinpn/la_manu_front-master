name: CI Infrastructure

on:
  push:
    paths:
      - "ansible/**"
      - "terraform/**"
      - "la_manu_front/**"
  pull_request:

jobs:
  full-ci:
    name: VÃ©rifications Ansible + Terraform + Frontend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: ğŸ›  Installer outils
        run: |
          sudo apt update
          sudo apt install -y ansible terraform npm docker.io
          sudo systemctl start docker

      # âœ… Ansible â€” Syntax Check + Dry-run
      - name: VÃ©rification Ansible
        run: |
          ansible-playbook ansible/site.yml --syntax-check
          ansible-playbook ansible/site.yml --check

      # ğŸ” Terraform â€” Init + Validate + Plan
      - name: VÃ©rification Terraform
        run: |
          terraform -chdir=terraform init -input=false
          terraform -chdir=terraform validate
          terraform -chdir=terraform plan -input=false

      # ğŸ§ª Jest â€” Tests frontend
      - name: Tests unitaires frontend
        run: |
          cd la_manu_front
          npm install
          npm run test -- --ci

      # ğŸ³ Docker â€” Build image frontend
      - name: Build image Docker frontend
        run: docker build -t la_manu_front:test la_manu_front
