name: CI Infrastructure

on:
  push:
    paths:
      - "ansible/**"
      - "terraform/**"
      - "la_manu_front/**"
  pull_request:
    paths:
      - "ansible/**"
      - "terraform/**"
      - "la_manu_front/**"

jobs:
  ci-checks:
    name: Vérifications CI
    runs-on: self-hosted

    steps:
      - name:  Checkout du dépôt
        uses: actions/checkout@v3

      - name:  Installer les outils
        run: |
          sudo apt update
          sudo apt install -y ansible terraform npm docker.io
          sudo systemctl start docker
          sudo usermod -aG docker $USER || true

      - name:  Vérifier syntaxe Ansible
        working-directory: ansible
        run: ansible-playbook -i hosts site.yml --syntax-check

      - name:  Dry-run Ansible
        working-directory: ansible
        run: ansible-playbook -i hosts site.yml --check --diff

      - name:  Terraform Init + Plan
        working-directory: terraform
        run: |
          terraform init -input=false
          terraform validate
          terraform plan -input=false

      - name:  Installer dépendances front
        working-directory: la_manu_front
        run: npm install

      - name:  Lancer les tests Jest
        working-directory: la_manu_front
        run: npm run test -- --ci

      - name:  Build image Docker Front
        working-directory: la_manu_front
        run: docker build -t la_manu_front:test .
