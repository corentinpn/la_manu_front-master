name: CI Infrastructure

on:
  push:
    paths:
      - "ansible/**"
      - "terraform/**"
      - "la_manu_front/**"
  pull_request:

jobs:
  full-ci:
    name: Vérifications Ansible + Terraform + Frontend
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout du dépôt
        uses: actions/checkout@v3

      - name: 🛠 Installer outils
        run: |
          sudo apt update
          sudo apt install -y ansible terraform npm docker.io
          sudo systemctl start docker

      # ✅ Ansible — Syntax Check + Dry-run
      - name: Vérification Ansible
        run: |
          ansible-playbook ansible/site.yml --syntax-check
          ansible-playbook ansible/site.yml --check

      # 🔍 Terraform — Init + Validate + Plan
      - name: Vérification Terraform
        run: |
          terraform -chdir=terraform init -input=false
          terraform -chdir=terraform validate
          terraform -chdir=terraform plan -input=false

      # 🧪 Jest — Tests frontend
      - name: Tests unitaires frontend
        run: |
          cd la_manu_front
          npm install
          npm run test -- --ci

      # 🐳 Docker — Build image frontend
      - name: Build image Docker frontend
        run: docker build -t la_manu_front:test la_manu_front
